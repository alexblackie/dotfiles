#!/usr/bin/env bash

set -euf -o pipefail

if [ "${1:-x}" = "x" ] ; then
  echo "Provide container name as first argument"
  exit 1
fi

REGISTRY="cr.blackieops.com"
APP_NAME="$1"
TAG="$(date +%Y%m%d%H%M)"
CONTAINER_NAME="$REGISTRY/$APP_NAME:$TAG"
LATEST_CONTAINER_NAME="$REGISTRY/$APP_NAME:latest"

docker build -t "$CONTAINER_NAME" .
docker tag "$CONTAINER_NAME" "$LATEST_CONTAINER_NAME"
docker push "$CONTAINER_NAME"
docker push "$LATEST_CONTAINER_NAME"

kubectl set image "deployment/$APP_NAME" "$APP_NAME=$CONTAINER_NAME"
